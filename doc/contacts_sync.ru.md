# Синхронизация контактов BSN Expert

Руководство для разработчиков приложений, которые хотят синхронизировать адресную книгу с BSN.Expert.

## Авторизация

- Получение ключа описано в [api.ru.md](/doc/api.ru.md).
- Заголовок: `Authorization: Bearer <API_KEY>`.
- Используйте ключ с разрешениями на «Контакты». Проверка прав идёт по действиям: `read`, `create`, `update`, `delete`.

## Эндпоинт

- `POST /api/contacts/sync`
- Формат: `application/json`

## Поля запроса

```json
{
  "current_timestamp": 1717230000000,   // ваш текущее время в мс (UTC), допускается разбег до 5 секунд
  "items": { // опционально
    "G...ADDRESS1": { "label": "Имя", "updated_at": 1717220000000 },
    "G...ADDRESS2": { "label": null,  "updated_at": 1717210000000 }
  }
}
```

- `current_timestamp` — обязательный, Unix время в миллисекундах. Если расхождение больше 5 000 мс, запрос отклоняется.
- `items` — обязательный объект контактов, описан ниже: 


## Структура контактов

Контакты представляют собой элементы объекта, где ключ — это корректный Stellar-адрес (G...), а значение — объект с:
  - `label`: строка или `null`, где отсутствие имени это пустая строка, а `null` означает удаление контакта,
  - `updated_at`: целое число (мс с эпохи), момент последнего изменения контакта.

## Логика клиента

Клиент должен помнить таймстемп последней удачной синхронизации, а самом начале спокойно исходить из того, что значение 0.
Посылая запрос к серверу, клиент может отправлять объект items, перечисляя те контакты, что обновились с прошлого раза.
В ответ, сервер, приняв правки, заодно расскажет о своих обновлениях в аналогичном формате. Клиент должен имлементировать эти обновления.

## Логика сервера

1. Загрузка текущих контактов клиента.
2. Сравнение с присланными данными:
   - Добавить, если у клиента есть label и его `updated_at` новее, а на сервере нет записи или label был пуст.
   - Обновить, если label отличается и клиентский `updated_at` новее.
   - Удалить, если у клиента `label=null`, на сервере было имя, и метка обновления новее.
   - Соответствующие действия выполняются только если у ключа есть соответствующие разрешения (`create`/`update`/`delete`).
3. При разрешении `read` сервер вернёт контакты, которые изменились на сервере после последней успешной синхронизации этим ключом.

## Ответ
```json
{
  "status": "OK",
  "report": {
    "errors": [],
    "permissions": { "read": true, "create": true, "update": true, "delete": false },
    "added": ["G..."],
    "not_added": [],
    "updated": [],
    "not_updated": [],
    "deleted": [],
    "not_deleted": []
  },
  "items": {
    "G...ADDRESS3": { "label": "Новое имя", "updated_at": 1717235000000 }
  }
}
```
- `report` — что удалось/не удалось применить с учётом прав.
- `items` — присутствует только при `read=true`; содержит изменения на сервере новее последней успешной синхронизации ключа (timestamp в мс).

Коды ответа:
- 200 — успех.
- 400 — проблемы формата (JSON, current_timestamp, items).
- 401 — отсутствует/неверный ключ.
- 403 — нет нужных прав.

## Пример cURL
```bash
curl -X POST https://bsn.expert/api/contacts/sync \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
        "current_timestamp": '"$(python - <<'PY' && import time; print(int(time.time()*1000)) PY)"',
        "items": {
          "GAAAA...1": { "label": "Alice", "updated_at": 1717220000000 },
          "GBBBB...2": { "label": null, "updated_at": 1717210000000 }
        }
      }'
```

## Замечания по времени
- Клиенту важно отправлять точное время в мс; держите синхронизацию часов (NTP) или поправки на сетевые лаги.
- Все сравнения ведутся в мс Unix time. Если хотите переиспользовать серверные метки, берите `updated_at` из ответа и сохраняйте на клиенте.
